# Complete Nginx Configuration for xraycad.bosschn.in
# Including Mammogram Viewer at /mammogram path

# HTTP to HTTPS redirect
server {
    if ($host = xraycad.bosschn.in) {
        return 301 https://$host$request_uri;
    }
    
    listen 80;
    server_name xraycad.bosschn.in;
    return 301 https://$host$request_uri;
    
    client_max_body_size 1000M;
    
    location ^~ /.well-known/pki-validation/ {
        allow all;
    }
    
    root /var/www/html;
    index index.html;
}

# HTTPS - Main server with both XRay CAD and Mammogram Viewer
server {
    listen 443 ssl;
    server_name xraycad.bosschn.in;
    
    # SSL Configuration
    ssl_certificate /etc/letsencrypt/live/xraycad.bosschn.in/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/xraycad.bosschn.in/privkey.pem;
    ssl_session_cache builtin:1000 shared:SSL:10m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    # Logging
    access_log /var/log/nginx/xray-access.log;
    error_log /var/log/nginx/xray-error.log;
    
    # Large file uploads
    client_max_body_size 2000M;
    
    # ============================================
    # MAMMOGRAM VIEWER - NEW APPLICATION
    # ============================================
    
    # Mammogram API (Backend)
    location /mammogram/api/ {
        # Remove /mammogram prefix when forwarding
        rewrite ^/mammogram/api/(.*) /api/$1 break;
        
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Long timeouts for DICOM processing
        proxy_connect_timeout 3600;
        proxy_read_timeout 3600;
        proxy_send_timeout 3600;
        
        # Disable buffering for large files
        proxy_buffering off;
        proxy_request_buffering off;
    }
    
    # Mammogram Frontend (React SPA)
    location /mammogram/ {
        alias /var/www/mammogram-viewer/frontend/dist/;
        try_files $uri $uri/ /mammogram/index.html;
        index index.html;
        
        # Cache static assets
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # Mammogram root redirect
    location = /mammogram {
        return 301 /mammogram/;
    }
    
    # ============================================
    # EXISTING XRAY CAD APPLICATION
    # ============================================
    
    # XRay CAD - Main application (existing)
    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 3600;
        proxy_read_timeout 3600;
        proxy_send_timeout 3600;
        
        proxy_pass http://10.184.3.15:8080;
        client_max_body_size 1000M;
    }
}

# Port 444 - Existing configuration
server {
    listen 444 ssl;
    server_name xraycad.bosschn.in;
    
    ssl_certificate /etc/letsencrypt/live/xraycad.bosschn.in/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/xraycad.bosschn.in/privkey.pem;
    ssl_session_cache builtin:1000 shared:SSL:10m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    access_log /var/log/nginx/xray-access.log;
    error_log /var/log/nginx/xray-error.log;
    
    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_connect_timeout 3600;
        proxy_read_timeout 3600;
        proxy_send_timeout 3600;
        
        client_max_body_size 1000M;
    }
}

# Port 447 - Existing configuration
server {
    listen 447 ssl;
    server_name xraycad.bosschn.in;
    
    ssl_certificate /etc/letsencrypt/live/xraycad.bosschn.in/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/xraycad.bosschn.in/privkey.pem;
    ssl_session_cache builtin:1000 shared:SSL:10m;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    access_log /var/log/nginx/xray-access.log;
    error_log /var/log/nginx/xray-error.log;
    
    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_connect_timeout 3600;
        proxy_read_timeout 3600;
        proxy_send_timeout 3600;
        
        proxy_ssl_verify off;
        proxy_pass http://10.184.3.15;
        client_max_body_size 1000M;
    }
}
